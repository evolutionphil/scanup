<analysis>
**original_problem_statement**:
The user's primary goal is to fix critical bugs preventing the iOS app from launching and monetizing. The main issues reported and worked on during this session are:
1.  **App Crash on iOS (P0):** The app crashes immediately after the splash screen on iOS. Crash logs point to a native module failure (), which was ultimately identified as a conflict between the Google Mobile Ads (AdMob) SDK and React Native's New Architecture at startup.
2.  **In-App Purchases (IAP) Not Working (P0):** A recurring problem. In this session, the issues were that prices were not appearing on the Go Premium screen on iOS, and buttons were unclickable. This was due to incorrect price parsing for iOS and timing issues with the StoreKit API.
3.  **Ads Not Showing (P1):** The user reported that interstitial ads were not showing after every 3 scans as intended.
4.  **Watermark Bug (P2):** For free users, a watermark appears within the app but was not being included in the exported PDF file when sharing.
5.  **Scanner Save Bug (P2):** When adding a second page to an existing document, the app would show a failed to save document error on iOS.
6.  **Build Failures (BLOCKER):** The agent and user encountered multiple build failures on iOS. These were caused by dependencies like  and  requiring React Native's New Architecture, which was initially disabled to prevent the AdMob startup crash.

**User's preferred language**: Turkish. The next agent MUST respond in Turkish.

**what currently exists?**
-   The project is an Expo (React Native) app with a FastAPI backend and Zustand for state management.
-   The IAP logic in  has been completely rewritten using a canonical ID pattern suggested by the user's friend. It now includes platform-specific code for handling pricing on iOS vs. Android and a timing delay to fix an iOS-specific issue.
-   The Ads logic in  has been refactored to be lazy. The AdMob SDK is no longer initialized at app startup but is now initialized on-demand (e.g., after the 3rd scan) to prevent the iOS startup crash.
-   To resolve build failures, **React Native's New Architecture is now ENABLED** in  ().
-   Fixes for the PDF watermark bug and the scanner save bug have been implemented in  and , respectively.

**Last working item**:
-   Last item agent was working: Fixing a critical iOS build failure and startup crash. The build failed because dependencies (, ) required New Architecture, but New Architecture was disabled to prevent the AdMob SDK from crashing the app on startup.
-   Agent's solution: The agent re-enabled New Architecture ( in ) and simultaneously rewrote the ad logic () to be fully lazy, meaning the AdMob SDK is not initialized until a user action triggers it (like the 3rd scan). This is intended to satisfy all library requirements while avoiding the startup crash.
-   Status: **IN PROGRESS** (The comprehensive fix has been implemented, but user testing is required to confirm it resolves both the build failure and the startup crash).
-   Agent Testing Done: N
-   Which testing method agent to use? The user needs to perform a clean build for iOS, either locally via Xcode or using An Expo user account is required to proceed.

Log in to EAS with email or username (exit and run eas login --help to see other login options)
Input is required, but stdin is not readable. Failed to display prompt: Email or username. Manual on-device testing is required.
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: iOS app crashes on startup (P0)
-   Issue 2: In-App Purchases (IAP) may still be broken on iOS (P0)
-   Issue 3: Ads functionality is unverified after major refactor (P1)
-   Issue 4: Scanner failed to save document fix is unverified (P2)
-   Issue 5: Watermark on shared PDF fix is unverified (P2)

**Issues Detail**:
-   **Issue 1: iOS app crashes on startup**
    -   **Description**: The app crashes with an  error, traced to the Google Mobile Ads SDK initializing at startup while New Architecture is enabled.
    -   **Attempted fixes**: The agent's final and most promising fix was to enable New Architecture (to solve build errors) and make AdMob initialization lazy (to solve the crash). This involves changes in , , , and .
    -   **Next debug checklist**:
        1.  User must perform a clean iOS build (An Expo user account is required to proceed.

Log in to EAS with email or username (exit and run eas login --help to see other login options)
Input is required, but stdin is not readable. Failed to display prompt: Email or username or env: load .env
env: export EXPO_TUNNEL_SUBDOMAIN EXPO_PACKAGER_HOSTNAME EXPO_PUBLIC_BACKEND_URL EXPO_USE_FAST_RESOLVER METRO_CACHE_ROOT EXPO_TOKEN
› It's recommended to commit all changes before proceeding in case you want to revert generated changes.
- Clearing android, ios
✔ Cleared android, ios code
- Creating native directories (./ios and ./android)
✔ Created native directories
- Updating package.json
✔ Updated package.json | no changes
- Running prebuild
- Running prebuild
- Running prebuild
- Running prebuild
✔ Finished prebuild
- Installing CocoaPods...
✔ Skipped installing CocoaPods because operating system is not on macOS. followed by Xcode build).
        2.  If the app still crashes, review the crash log. The crash should no longer be related to .
        3.  If the build fails, the error is likely still related to New Architecture configuration.
    -   **Why fix this issue and what will be achieved with the fix?**: The app is completely unusable on iOS. This is the highest priority blocker.
    -   **Status**: IN PROGRESS (User verification pending)
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?**: Frontend (iOS on-device).

-   **Issue 2: In-App Purchases (IAP) may still be broken on iOS**
    -   **Description**: User reported that IAP prices were not showing and buttons were unclickable.
    -   **Attempted fixes**:  was rewritten to use platform-specific price parsing ( for iOS) and a 400ms delay after  to handle StoreKit timing issues. The code now appears correct.
    -   **Next debug checklist**:
        1.  Once a stable build is achieved, test the Go Premium screen on a real iOS device using a TestFlight build and a Sandbox Apple ID.
        2.  Verify that prices are displayed correctly.
        3.  Verify that purchase buttons are clickable and initiate the purchase flow.
    -   **Why fix this issue and what will be achieved with the fix?**: This is the app's core monetization feature.
    -   **Status**: IN PROGRESS (User verification pending)
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?**: Frontend (iOS on-device TestFlight).

-   **Issue 3: Ads functionality is unverified after major refactor**
    -   **Description**: The ad logic was completely refactored to be lazy-loaded to prevent crashes. It's unclear if it now functions as intended (i.e., shows an ad after 3 scans).
    -   **Attempted fixes**: The logic was moved from a global  component and startup initialization into a lazy  function in , which is called from .
    -   **Next debug checklist**:
        1.  On a stable build, perform 3 document scans.
        2.  Verify that the ad initialization is triggered and an interstitial ad is shown.
        3.  Check console logs for  and .
    -   **Why fix this issue and what will be achieved with the fix?**: This is a secondary monetization feature.
    -   **Status**: IN PROGRESS (User verification pending)
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?**: Frontend (iOS/Android).

-   **Issue 4 & 5: Scanner save and PDF watermark fixes are unverified**
    -   **Description**: The agent implemented fixes for a scanner save error and a missing watermark on shared PDFs.
    -   **Attempted fixes**:
        -   Scanner: Changed  to use  to get the latest state.
        -   Watermark: Modified  to include the watermark HTML/CSS when generating the PDF for free users.
    -   **Next debug checklist**:
        1.  Test adding a new page to an existing document.
        2.  As a free user, share a document as a PDF and verify the watermark is present.
    -   **Why fix this issue and what will be achieved with the fix?**: Improves core functionality and monetization hints.
    -   **Status**: IN PROGRESS (User verification pending)
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?**: Frontend.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   (P2) **JPG Export Watermark**: The agent noted that adding a watermark to JPG exports was deferred as it is more complex than adding it to the HTML-to-PDF flow.
-   **Future Tasks (From previous fork, to be addressed after app is stable)**:
    -   (P1) Re-integrate Firebase on iOS (Analytics, Crashlytics). **DO NOT ATTEMPT UNTIL APP IS STABLE.**
    -   (P2) Batch Export: Implement UI to select and merge multiple documents into one PDF.
    -   (P3) Share Extension ().
    -   (P3) Home screen Widgets.

**Completed work in this session**
-   **IAP Refactor ()**: Completely rewrote the IAP logic to use a robust canonical ID pattern, fixing platform-specific price parsing and iOS timing issues.
-   **Ads Refactor for Crash Fix ()**: Rewrote the ad logic to use lazy initialization, preventing the AdMob SDK from crashing the app on startup under New Architecture.
-   **Build System Fixes (, )**: Resolved a circular dependency between native module requirements by enabling New Architecture () and adapting the code to work with it. Removed conflicting  and added necessary plugins (, ). Created  for .
-   **Scanner Logic ()**:
    -   Fixed a bug preventing saving a second page to an existing document.
    -   Implemented the show ad after 3 scans logic, including the new lazy ad initialization.
    -   Integrated  to prevent UI freezes on iOS after scanning.
-   **PDF Watermark Fix ()**: Added the watermark overlay to the HTML that is converted to PDF for free users.
-   **Version Bumping**: Updated  multiple times with new ,  (Android), and  (iOS) as requested by the user.

**Code Architecture**


**Key Technical Concepts**
-   **React Native New Architecture**: The central challenge. It is now **ENABLED** to support modern libraries. This required significant code changes to prevent crashes.
-   **Lazy Initialization**: The key pattern used to solve the AdMob startup crash. The SDK is only initialized after a user interaction, not on app load.
-   ****: The implementation has been hardened significantly with a canonical ID system, platform-specific price parsing, and iOS-specific timing delays.
-   ****: Identified as the source of the iOS startup crash when New Architecture is enabled. Now handled with lazy initialization.
-   **Zustand**: Used for all major state management (, ).
-   ****: Used in  to schedule navigation after the UI thread is free, preventing white screen freezes on iOS.

**All files of reference**
-   : **CRITICAL**. Defines the build environment, including .
-   : **CRITICAL**. Contains the new lazy-initialization logic for ads.
-   : **CRITICAL**. Contains the rewritten, robust IAP logic.
-   : **CRITICAL**. The root of the app. Must NOT contain any eager native module initializations that could crash.
-   : **CRITICAL**. The entry point for the new lazy ad initialization flow.

**Critical Info for New Agent**
-   **THE MAIN STRATEGY IS: NEW ARCHITECTURE ON, LAZY ADS ON.** Do not change this unless it is proven to fail. This combination is intended to fix both the build errors and the startup crash.
-   **All testing for IAP and Ads MUST be done on a real device** using a TestFlight build (iOS) or Internal Test track (Android). These features do not work in simulators or Expo Go. Be prepared for a long feedback loop.
-   The user is extremely frustrated with the recurring crashes and IAP issues. Be clear, concise, and focus on verifying the latest set of fixes. Explain *why* the previous attempts failed and *why* the current one should work.
-   The next step is for the user to perform a **clean build** (An Expo user account is required to proceed.

Log in to EAS with email or username (exit and run eas login --help to see other login options)
Input is required, but stdin is not readable. Failed to display prompt: Email or username is recommended) and test on a real device. Guide them through this.

**Last 10 User Messages** 
-   **346**: User forwards friend's analysis of a  build error, correctly identifying the New Architecture conflict and recommending enabling it while making Ads lazy.
-   **329**: User forwards build error from  requiring New Architecture.
-   **327**: User asks if they can run the project directly from Xcode.
-   **306**: User reports the app is crashing on startup on iOS and provides a crash log and friend's analysis blaming the AdMob SDK.
-   **300**: User provides the last working iOS version info (, build ).
-   **295**: User asks to update Android  to  and  to .
-   **293**: User expresses frustration and asks for a clear explanation of why IAP has been so difficult to fix.
-   **278**: User reports the app is crashing!!! and provides a crash log.
-   **274**: User provides their latest  and asks the agent to update its version to match.
-   **256**: User forwards a build error from EAS, showing both a lockfile conflict and a Reanimated/New Architecture error.

**Project Health Check:**
-   **Broken**:
    -   iOS App Stability (Startup Crash) - Fix implemented, pending verification.
    -   In-App Purchases (iOS) - Fix implemented, pending verification.
-   **Mocked**:
    -   None.
-   **Pending Verification**:
    -   The entire suite of recent fixes: iOS crash, IAP functionality, Ads functionality, scanner save bug, and PDF watermark.

**3rd Party Integrations**
-   ****: For In-App Purchases. Heavily modified and now hopefully stable.
-   ****: For AdMob. Identified as the source of the iOS crash, now initialized lazily.
-   ****: For Google Authentication.
-   ****: For animations. Its requirement for New Architecture drove many of the recent build system changes.
-   ****: A dependency that also requires New Architecture.
-   ****: For Push Notifications.
-   ****: Added to request ATT permission for ads on iOS.

**Testing status**
-   Testing agent used after significant changes: NO (not applicable for these native build/runtime issues).
-   Troubleshoot agent used after agent stuck in loop: YES (implicitly, via user forwarding friend's detailed analyses).
-   Test files created: None.
-   Known regressions: The iOS startup crash and broken IAP were major regressions that this session aimed to fix.

**What agent forgot to execute**
-   The task to add a watermark to **JPG exports** was noted as complex and deferred, and not revisited. This remains an incomplete part of the watermark feature.

</analysis>

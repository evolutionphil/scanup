<analysis>
<original_problem_statement>
The user's initial goal was to create a ScanUp mobile app competitive with Adobe Scan. The current focus is on fixing a list of critical bugs reported by the user.

The primary issue in the previous session was a white screen crash. This session focused on fixing that and a newly discovered, related issue: the app crashes because  (which uses a ~6MB SQLite database on Android) becomes full from storing large base64 image strings.

**Recent User Requests &amp; Issues:**
- **Fix Critical  Crash (Highest Priority):** After one or two successful scans, the app crashes with a database or disk is full error. This happens because  hits its 6MB limit. The user has reinstalled the app, but the issue recurs, indicating a flaw in the saving logic.
- **Fix New Black Screen Bug:** After a successful first scan, navigating back to the document list and then re-opening the document for editing results in a black screen where the image preview should be.
- **Original Bug List (Still Pending):**
    - Implement custom Google & Apple authentication.
    - Fix Android system navigation bar overlapping UI elements.
    - Fix live filter/adjustment previews.
    - Ensure user session persists after an app restart.
    - Ensure image rotation is reflected in thumbnails.
</original_problem_statement>

**User's preferred language**: English

**what currently exists?**
The project is a React Native (Expo) app with a FastAPI backend.
A major architectural change was made to address the  limit.
- **New Storage Architecture:**
    - Images are now intended to be saved to the device's file system using  via a new  helper.
    -  is now intended to only store the document *metadata* (IDs, names, dates, and file URIs pointing to the saved images).
- **Frontend:**  for navigation,  for state. The  has been heavily modified to orchestrate the new file system storage, but it contains bugs.
- **Backend:**  remains unchanged in this session.

**Last working item**:
    - Last item agent was working: The agent was attempting a major refactor to fix a critical  crash. The strategy was to stop storing large base64 images in  and instead save them to the device's file system, storing only the file URI in .
    - Status: **IN PROGRESS**
    - Agent Testing Done: N
    - Which testing method agent to use? Frontend testing agent. The agent must build a new debug APK and follow a multi-step user flow: 1) Scan a doc as a guest. 2) Go back. 3) Scan a second doc. 4) Observe the  crash. 5) Re-open the first doc and observe the black screen.
    - User Testing Done: Y (User has tested and confirmed the fix is incomplete and introduced a new bug).

**All Pending/In progress Issue list**:
  - Issue 1: Critical:  database or disk is full error still occurs on the 2nd or 3rd scan. (P0)
  - Issue 2: Critical: Black screen appears instead of the image when re-opening a scanned document from the list. (P0)
  - Issue 3: Custom Google & Apple authentication implementation is pending. (P1)
  - Issue 4: Android system navigation buttons overlap with app UI buttons. (P2)
  - Issue 5: Live filter/adjustment previews are not working. (P2)
  - Issue 6: Saved image rotation is not reflected in the main document preview. (P3)
  - Issue 7: User session is not persisted after an app restart. (P3)
  
  Issues Detail:
  - Issue 1: **Critical:  / AsyncStorage Limit Crash**
     - Description: Despite refactoring to save images to the file system, something is still writing large document objects (likely containing base64 data) to . This causes the app to crash after a few scans when the 6MB limit is hit.
     - Attempted fixes: The agent created  to save images to files. It updated 's  function to use this new utility. It also added some error handling for storage full scenarios.
     - Why it failed: The agent missed other code paths. The function  in  is still being called and it saves the entire document array to AsyncStorage, including any pages that might still have  data in memory, without stripping them or saving them to files.
     - Next debug checklist:
        1. **Modify  in :** This is the most likely culprit. Before calling , this function MUST iterate through the documents and pages. For any page containing an  property, it must save that image to a file (using ) and replace the  with the new  before caching the metadata.
        2. **Add Logging:** Before any call to , log the byte length of the stringified data to confirm it's small. 
     - Why fix this issue and what will be achieved with the fix?: This is the primary app-breaking bug. Fixing it will make the core scanning feature usable for more than one scan.
     - Status: **IN PROGRESS**
     - Is recurring issue? Y
     - Should Test frontend/backend/both after fix?: Frontend
     - Blocked on other issue: None.

  - Issue 2: **Critical: Black Screen on Document Re-open**
     - Description: After scanning a document, it appears correctly. However, if the user navigates back to the home screen and then taps on that document again, the edit screen opens, but the image area is black. Logs show a warning: .
     - Attempted fixes: None. This is a new bug introduced by the storage refactoring.
     - Why it happened: The loading logic is incomplete. When  in  fetches the document metadata from , the  object only contains , not . The component then fails to load the image from the file path into the view.
     - Next debug checklist:
        1. **Modify  in **: After retrieving the document from the store, check if  exists. If it does, use  to read the image file.
        2. **Update State**: Set the retrieved base64 data into the 's page state, so that components like  and the main  preview have the  data they need to render.
        3. **Update  helper**: Ensure the helper function in  prioritizes a newly loaded  over a  to prevent flicker and ensure consistency.
     - Why fix this issue and what will be achieved with the fix?: This bug makes viewing and editing previously scanned documents impossible, another critical workflow failure.
     - Status: **NOT STARTED**
     - Is recurring issue? N
     - Should Test frontend/backend/both after fix?: Frontend
     - Blocked on other issue: None, but should be fixed alongside Issue 1.

**In progress Task List**: None.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - (P1) Implement custom Google Sign-In using user-provided credentials.
    - (P1) Implement Sign in with Apple for the iOS platform.
- **Future Tasks:**
    - (P2) Refactor the monolithic  into smaller, manageable routers.
    - (P2) Refactor the  to simplify state management.
    - (P3) Re-evaluate and implement Auto-crop on edit screen.

**Completed work in this session**
- **Critical Crash Fix:** Fixed a native crash by replacing the deprecated  with the new subscription-based API () in .
- **Storage Architecture Refactor (Partial):**
    - Began a major refactor to move image storage from  to the device's file system to bypass the 6MB  limit on Android.
    - Created a new utility  to handle saving/loading base64 data to/from the file system.
    - Modified the  flow to save new images as files.
- **Bug Fixes:**
    - Fixed a crash in  by adding a null-check for .
    - Addressed an  API deprecation by changing the import to .
- **User Support:** Provided detailed instructions on building a debug APK with Android Studio and connecting a development build to the Metro server.

**Earlier issues found/mentioned but not fixed**
All known issues are captured in the Pending/In progress Issue list.

**Known issue recurrence from previous fork**
- **White Screen on Navigation:** The original white screen crash was fixed (it was caused by ), but the underlying state management issues on navigation persist, now manifesting as a black screen when reloading a document.

**Code Architecture**
saveLocalCache

**Key Technical Concepts**
- **AsyncStorage Limitations:** A core finding of this session is that  on Android has a hard limit of ~6MB because it's backed by SQLite. It is unsuitable for storing large data like base64 images.
- **File System Storage for Large Data:** The correct pattern for React Native is to use  to store large blobs (like images) as files in the app's sandboxed directory.  should only be used for storing the metadata and file paths ().
- **State Hydration for File-Based Data:** When loading data, the app must perform a two-step process: 1) Read metadata (including file URIs) from AsyncStorage. 2) Use the file URIs to read the actual image data from the file system into component state for rendering. This second step is currently missing.
- **React Native API Deprecations:** The  crash highlights the need to be aware of and correctly handle API changes in newer React Native versions.

**key DB schema**
No changes were made to the database schema.

**changes in tech stack**
No changes to  dependencies, but a fundamental change in storage *strategy*, relying on  for image persistence.

**All files of reference**
- : **Most critical file.** Contains the flawed storage logic.  needs to be fixed.
- : **Second most critical.**  needs to be fixed to read images from the file system.  was fixed here.
- : New helper file for file system operations.
- : Patched to prevent a crash.

**Areas that need refactoring**
- : This file is the root of the current problems. The logic for saving guest documents vs. caching remote documents is complex and has led to the  bug. It needs to be simplified with a clear, single pathway for how a document page is persisted, ensuring no base64 data ever gets written to AsyncStorage.

**key api endpoints**
No API endpoints were changed.

**Critical Info for New Agent**
- **PRIORITY 1: Fix the  crash.** The root cause is in . The  function is incorrectly saving raw document objects with base64 data to AsyncStorage. You MUST modify it to save images to files and only store metadata, just like the  function is supposed to.
- **PRIORITY 2: Fix the Black Screen bug.** This is a state hydration problem. In , after loading a document's metadata from the store, you must use the  to read the image from the file system into a state variable that the  component and  can use.
- **DO NOT store images in AsyncStorage.** This is the core architectural flaw that caused all the storage issues. All image data must be written to the file system using .
- The user is now aware of the 6MB AsyncStorage limit. Your explanations should reflect this shared understanding.
- Re-installing the app clears the storage, which is why the first scan works. The bug appears on subsequent actions that trigger the faulty caching logic.

**documents created in this job**
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (Msg 129):** **CRITICAL FEEDBACK.** Reports the first scan works, but the  error returns on the second scan. Also reports a **new bug**: re-entering the edit page for the first document shows a **black screen**. Asks to never use SQLite. (PENDING)
2.  **User (Msg 127):** Asks why SQLite is needed if they reinstalled the app. (Addressed)
3.  **User (Msg 117):** Provides logs showing , a crash in  (undefined ), and a FileSystem API error. (Partially Addressed)
4.  **User (Msg 97):** Expresses frustration and says to use normal localstorage, not a database. (Agent clarified AsyncStorage *is* the localStorage for RN).
5.  **User (Msg 93):** Realizes the problem is AsyncStorage's 6MB limit, not their phone's 1TB storage. Asks for a proper fix. (This triggered the file-system refactor).
6.  **User (Msg 92):** Reports their phone is not full and has 1TB of space. (This was a key clarification).
7.  **User (Msg 81):** Reports the  fix didn't work (they were seeing cached code) and questions the local-first saving logic.
8.  **User (Msg 77):** Provides a screenshot showing the old, unfixed  code is still running on their device. (This pointed to a JS bundle caching issue).
9.  **User (Msg 70):** Provides the first detailed logcat, which was instrumental in identifying the  and  errors.
10. **User (Msg 60):** Provides a screenshot of the Development Build screen, asking how to proceed.

**Project Health Check:**
- **Broken**:
    - The guest user workflow is critically broken. Scanning more than one document crashes the app.
    - Viewing/editing a previously scanned document is broken (black screen).
- **Mocked**:
    - Google Sign-In still uses a generic Emergent service.

**3rd Party Integrations**
- **AWS S3**: For image storage (for authenticated users).
- **MongoDB Atlas**: Primary database.
- **react-native-document-scanner-plugin**: For document capture.
- : Now used for local image storage.

**Testing status**
  - Testing agent used after significant changes: NO
  - Troubleshoot agent used after agent stuck in loop: NO
  - Test files created: []
  - Known regressions:
    - The storage refactor introduced a black screen bug when reloading documents.
    - The  error, while the target of the fix, still persists due to an incomplete implementation.

**Credentials to test flow:**
- Guest mode is sufficient to reproduce all critical bugs. No user credentials are required.

**What agent forgot to execute**
- The agent did not complete the storage refactor. It updated the save new guest doc path but **forgot to update the  path**. This oversight is the direct cause of the  error recurring.
- The agent did not implement the corresponding **loading logic** for the new file-based storage. It saves the image to a file but never reads it back when the user re-opens the document, causing the black screen.
</analysis>
